/*****
    place 30' radius effect centered on ACTOR
    Target all UNDEAD creatures in that radius
    Setup save... Roll save...  
    if Success: nothing happens
    if Failure: Mark TURNED (CE)
                duration: 1 min or until first damage done to the creature
                if cleric level > 16 ... CR <= 4 DEAD else
                  if cleric level > 13 ... CR <= 3 DEAD else
                    if cleric level > 10 ... CR <= 2 DEAD else
                      if cleric level > 7 ... CR <= 1 DEAD else
                        if cleric level >4 ... CR <= 1/2 DEAD
*****/

if (args[0].macroPass === "preambleComplete") {
    let workflow = MidiQOL.Workflow.getWorkflow(args[0].uuid);
    console.log ("MACRO TEST | STARTING TARGETS: %O",workflow.targets);
    // I am stealing the activation condition as a string for the creature type I want to hit
    const activationCondition = args[0].itemData.data.activation.condition.toLowerCase();
    for (let target of workflow.targets) {
        let creatureType = target.actor.data.data.details.type;
        if (!([creatureType.value.toLowerCase(), creatureType.subtype.toLowerCase()].includes(activationCondition.toLowerCase()))) {
            console.log ("MACRO TEST | REMOVE TARGET: %O %s", target, creatureType);
            workflow.targets.delete(target);
        }
    }
} else if (args[0].macroPass === "postActiveEffects") {
    let workflow = MidiQOL.Workflow.getWorkflow(args[0].uuid);
    const pcActor = workflow.actor;
    console.log ("MACRO TEST | REMOVED ALL NON UNDEAD TARGETS: %O",workflow.targets);

    // set CR to destory
    let crDestroy = 0.0;
    if (workflow.targets.size === 0) return;
    const actorClass = testClass(pcActor, "cleric", null, 1);
    if (!actorClass) return;
    if (actorClass.levels > 16) crDestroy = 4;
        else if (actorClass.levels > 13) crDestroy = 3;
            else if (actorClass.levels > 10) crDestroy = 2;
                else if (actorClass.levels > 7) crDestroy = 1;
                    else if (actorClass.levels > 4) crDestroy = 0.5;
    
    // set HP = 0 for all targets of the CR or less
    let target = null;
    for (target of workflow.targets) 
        if (target.document._actor.data._source.data.details.cr <= crDestroy) {
            console.log ("MACRO TEST | DESTROY TARGET: %O %d",target, target.document._actor.data._source.data.details.cr);
            await target.actor.update({"data.attributes.hp.value": 0});
        }
} 

// Test PC Class, Subclass and Class Level, RETURN the class object or null
function testClass (testActor, className, subClassName, levels) {
    let theClass = testActor.data.data.classes[className] ;
    if (theClass) {
        if ((levels > 0) && (theClass.levels >= levels)) {
            if (subClassName === null || (theClass.subclass === subClassName)) {
                return theClass;
            }
        }
    }
    return null;
}